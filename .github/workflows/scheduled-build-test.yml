name: Scheduled Build Test

on:
  schedule:
    # ë§¤ì¼ ì˜¤ì „ 9ì‹œì™€ ì˜¤í›„ 6ì‹œì— ì‹¤í–‰ (KST ê¸°ì¤€)
    - cron: "0 0,9 * * *"
  workflow_dispatch: # ìˆ˜ë™ íŠ¸ë¦¬ê±° í—ˆìš©

jobs:
  build-backend:
    name: ë°±ì—”ë“œ ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: JDK 17 ì„¤ì •
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"

      - name: Gradle ê¶Œí•œ ì„¤ì •
        working-directory: ./be15_DevEagles_BE
        run: chmod +x gradlew

      - name: Gradle ìºì‹œ ì„¤ì •
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('be15_DevEagles_BE/**/*.gradle*', 'be15_DevEagles_BE/**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: ì˜ì¡´ì„± ë‹¤ìš´ë¡œë“œ
        working-directory: ./be15_DevEagles_BE
        run: ./gradlew dependencies --no-daemon
        env:
          SPRING_PROFILES_ACTIVE: test

      - name: ì»´íŒŒì¼ í…ŒìŠ¤íŠ¸
        working-directory: ./be15_DevEagles_BE
        run: ./gradlew compileJava --no-daemon
        id: compile-test
        env:
          SPRING_PROFILES_ACTIVE: test

      - name: ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        working-directory: ./be15_DevEagles_BE
        run: ./gradlew test --no-daemon
        id: unit-test
        env:
          SPRING_PROFILES_ACTIVE: test
          JWT_SECRET: ${{ secrets.JWT_SECRET || 'test-jwt-secret-key-for-ci-cd-testing-purposes-only' }}
          DB_URL: ${{ secrets.TEST_DB_URL || 'jdbc:h2:mem:testdb' }}
          DB_USERNAME: ${{ secrets.TEST_DB_USERNAME || 'sa' }}
          DB_PASSWORD: ${{ secrets.TEST_DB_PASSWORD || '' }}
          REDIS_HOST: ${{ secrets.TEST_REDIS_HOST || 'localhost' }}
          REDIS_PORT: ${{ secrets.TEST_REDIS_PORT || '6379' }}

      - name: ë¹Œë“œ ì‹¤í–‰
        working-directory: ./be15_DevEagles_BE
        run: ./gradlew build -x test --no-daemon
        id: gradle-build
        env:
          SPRING_PROFILES_ACTIVE: prod
          JWT_SECRET: ${{ secrets.JWT_SECRET || 'test-jwt-secret-key-for-ci-cd-testing-purposes-only' }}
          DB_URL: ${{ secrets.DB_URL || 'jdbc:h2:mem:testdb' }}
          DB_USERNAME: ${{ secrets.DB_USERNAME || 'sa' }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD || '' }}
          REDIS_HOST: ${{ secrets.REDIS_HOST || 'localhost' }}
          REDIS_PORT: ${{ secrets.REDIS_PORT || '6379' }}

      - name: í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: backend-test-results
          path: be15_DevEagles_BE/build/reports/tests/test/

      - name: ë¹Œë“œ ìƒíƒœ í™•ì¸
        id: build-status
        run: |
          if [[ "${{ steps.compile-test.outcome }}" == "success" && "${{ steps.unit-test.outcome }}" == "success" && "${{ steps.gradle-build.outcome }}" == "success" ]]; then
            echo "status=ì„±ê³µ" >> $GITHUB_OUTPUT
            echo "details=ì»´íŒŒì¼, í…ŒìŠ¤íŠ¸, ë¹Œë“œ ëª¨ë‘ ì„±ê³µ" >> $GITHUB_OUTPUT
          else
            echo "status=ì‹¤íŒ¨" >> $GITHUB_OUTPUT
            echo "details=ì»´íŒŒì¼: ${{ steps.compile-test.outcome }}, í…ŒìŠ¤íŠ¸: ${{ steps.unit-test.outcome }}, ë¹Œë“œ: ${{ steps.gradle-build.outcome }}" >> $GITHUB_OUTPUT
          fi

      - name: Discordì— ë°±ì—”ë“œ ë¹Œë“œ ê²°ê³¼ ì „ì†¡
        uses: sarisia/actions-status-discord@v1
        if: always()
        with:
          webhook: ${{ secrets.BUILDTEST_DISCORD_WEBHOOK_URL }}
          title: "ğŸ”§ ë°±ì—”ë“œ ë¹Œë“œ í…ŒìŠ¤íŠ¸ ê²°ê³¼"
          description: |
            **ë¹Œë“œ ìƒíƒœ**: ${{ steps.build-status.outputs.status }}
            **ì„¸ë¶€ ì‚¬í•­**: ${{ steps.build-status.outputs.details }}
            **ì»¤ë°‹**: ${{ github.sha }}
            **ë¸Œëœì¹˜**: ${{ github.ref_name }}
          color: ${{ steps.build-status.outputs.status == 'ì„±ê³µ' && '0x00ff00' || '0xff0000' }}
          username: "DevEagles CI/CD"

  build-frontend:
    name: í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: "be15_DevEagles_FE/package-lock.json"

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        working-directory: ./be15_DevEagles_FE
        run: npm ci
        id: npm-install

      - name: ë¦°íŠ¸ ê²€ì‚¬
        working-directory: ./be15_DevEagles_FE
        run: npm run lint
        continue-on-error: true
        id: lint-check

      - name: íƒ€ì… ê²€ì‚¬ (TypeScript)
        working-directory: ./be15_DevEagles_FE
        run: npm run type-check
        continue-on-error: true
        id: type-check

      - name: ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        working-directory: ./be15_DevEagles_FE
        run: npm run test:unit
        continue-on-error: true
        id: unit-test
        env:
          NODE_ENV: test

      - name: ë¹Œë“œ ì‹¤í–‰
        working-directory: ./be15_DevEagles_FE
        run: npm run build
        id: npm-build
        env:
          NODE_ENV: production
          VITE_API_BASE_URL: ${{ secrets.VITE_API_BASE_URL || 'http://localhost:8080/api' }}
          VITE_WS_URL: ${{ secrets.VITE_WS_URL || 'ws://localhost:8080/ws' }}
          VITE_APP_TITLE: ${{ secrets.VITE_APP_TITLE || 'DevEagles' }}
          VITE_ENVIRONMENT: ${{ secrets.VITE_ENVIRONMENT || 'development' }}

      - name: ë¹Œë“œ ê²°ê³¼ë¬¼ í™•ì¸
        working-directory: ./be15_DevEagles_FE
        run: |
          echo "ë¹Œë“œ ê²°ê³¼ë¬¼ í¬ê¸° í™•ì¸:"
          du -sh dist/ || echo "dist ë””ë ‰í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤"
          echo "ë¹Œë“œ íŒŒì¼ ëª©ë¡:"
          ls -la dist/ || echo "dist ë””ë ‰í† ë¦¬ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤"

      - name: í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: frontend-test-results
          path: |
            be15_DevEagles_FE/coverage/
            be15_DevEagles_FE/test-results/

      - name: ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: frontend-build
          path: be15_DevEagles_FE/dist/

      - name: ë¹Œë“œ ìƒíƒœ í™•ì¸
        id: fe-build-status
        run: |
          if [[ "${{ steps.npm-install.outcome }}" == "success" && "${{ steps.npm-build.outcome }}" == "success" ]]; then
            echo "status=ì„±ê³µ" >> $GITHUB_OUTPUT
            echo "details=ì˜ì¡´ì„± ì„¤ì¹˜, ë¹Œë“œ ì„±ê³µ | ë¦°íŠ¸: ${{ steps.lint-check.outcome }}, íƒ€ì…ì²´í¬: ${{ steps.type-check.outcome }}, í…ŒìŠ¤íŠ¸: ${{ steps.unit-test.outcome }}" >> $GITHUB_OUTPUT
          else
            echo "status=ì‹¤íŒ¨" >> $GITHUB_OUTPUT
            echo "details=ì˜ì¡´ì„±: ${{ steps.npm-install.outcome }}, ë¹Œë“œ: ${{ steps.npm-build.outcome }}, ë¦°íŠ¸: ${{ steps.lint-check.outcome }}, íƒ€ì…ì²´í¬: ${{ steps.type-check.outcome }}, í…ŒìŠ¤íŠ¸: ${{ steps.unit-test.outcome }}" >> $GITHUB_OUTPUT
          fi

      - name: Discordì— í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ ê²°ê³¼ ì „ì†¡
        uses: sarisia/actions-status-discord@v1
        if: always()
        with:
          webhook: ${{ secrets.BUILDTEST_DISCORD_WEBHOOK_URL }}
          title: "ğŸ¨ í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ í…ŒìŠ¤íŠ¸ ê²°ê³¼"
          description: |
            **ë¹Œë“œ ìƒíƒœ**: ${{ steps.fe-build-status.outputs.status }}
            **ì„¸ë¶€ ì‚¬í•­**: ${{ steps.fe-build-status.outputs.details }}
            **ì»¤ë°‹**: ${{ github.sha }}
            **ë¸Œëœì¹˜**: ${{ github.ref_name }}
          color: ${{ steps.fe-build-status.outputs.status == 'ì„±ê³µ' && '0x00ff00' || '0xff0000' }}
          username: "DevEagles CI/CD"

  summary:
    name: ë¹Œë“œ í…ŒìŠ¤íŠ¸ ìš”ì•½
    runs-on: ubuntu-latest
    needs: [build-backend, build-frontend]
    if: always()

    steps:
      - name: ì „ì²´ ê²°ê³¼ ìš”ì•½
        run: |
          echo "ë°±ì—”ë“œ ë¹Œë“œ ê²°ê³¼: ${{ needs.build-backend.result }}"
          echo "í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ ê²°ê³¼: ${{ needs.build-frontend.result }}"

      - name: Discordì— ì „ì²´ ìš”ì•½ ì „ì†¡
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.BUILDTEST_DISCORD_WEBHOOK_URL }}
          title: "ğŸ“Š ì „ì²´ ë¹Œë“œ í…ŒìŠ¤íŠ¸ ìš”ì•½"
          description: |
            **ë°±ì—”ë“œ**: ${{ needs.build-backend.result == 'success' && 'âœ… ì„±ê³µ' || 'âŒ ì‹¤íŒ¨' }}
            **í”„ë¡ íŠ¸ì—”ë“œ**: ${{ needs.build-frontend.result == 'success' && 'âœ… ì„±ê³µ' || 'âŒ ì‹¤íŒ¨' }}

            **ì‹¤í–‰ ì‹œê°„**: ${{ github.event_name == 'schedule' && 'ì •ê¸° ì‹¤í–‰' || 'ìˆ˜ë™ ì‹¤í–‰' }}
            **ì»¤ë°‹**: ${{ github.sha }}
            **ë¸Œëœì¹˜**: ${{ github.ref_name }}
          color: ${{ needs.build-backend.result == 'success' && needs.build-frontend.result == 'success' && '0x00ff00' || '0xff0000' }}
          username: "DevEagles CI/CD"
