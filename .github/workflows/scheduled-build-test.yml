name: Scheduled Build Test

on:
  schedule:
    # 1시간마다 실행
    - cron: "0 */1 * * *"
  workflow_dispatch: # 수동 트리거 허용

jobs:
  build-backend:
    name: 백엔드 빌드 테스트
    runs-on: ubuntu-latest

    steps:
      - name: 코드 체크아웃
        uses: actions/checkout@v3

      - name: JDK 17 설정
        uses: actions/setup-java@v3
        with:
          java-version: "17"
          distribution: "temurin"

      - name: Gradle 파일 확인
        run: |
          echo "백엔드 디렉토리 구조 확인:"
          ls -la ./be15_DevEagles_BE
          echo "Gradle 파일 확인:"
          ls -la ./be15_DevEagles_BE/gradle
          echo "Gradle wrapper 확인:"
          ls -la ./be15_DevEagles_BE/gradle/wrapper

      - name: Gradle wrapper jar 다운로드
        run: |
          mkdir -p ./be15_DevEagles_BE/gradle/wrapper
          wget -O ./be15_DevEagles_BE/gradle/wrapper/gradle-wrapper.jar https://github.com/gradle/gradle/raw/v8.3.0/gradle/wrapper/gradle-wrapper.jar
          chmod +x ./be15_DevEagles_BE/gradlew
          ls -la ./be15_DevEagles_BE/gradle/wrapper

      - name: Gradle 캐시 설정
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('be15_DevEagles_BE/**/*.gradle*', 'be15_DevEagles_BE/**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Gradle 빌드
        working-directory: ./be15_DevEagles_BE
        run: |
          # 간단한 빌드만 시도
          ./gradlew -v
          ./gradlew tasks
        continue-on-error: true
        id: gradle-build

      - name: 빌드 상태 확인
        id: build-status
        run: |
          if ${{ steps.gradle-build.outcome == 'success' }}; then
            echo "status=성공" >> $GITHUB_OUTPUT
          else
            echo "status=실패" >> $GITHUB_OUTPUT
          fi

      - name: Discord에 백엔드 빌드 결과 전송
        uses: sarisia/actions-status-discord@v1
        if: always()
        with:
          webhook: https://discordapp.com/api/webhooks/1373208730384076830/xJglBK0zwY531d7uyP6hh62DnjqwtowArFplYLKJ1ZfR6i35mQSv1NDf2kTaYo-zD03T
          title: "백엔드 빌드 테스트 결과"
          description: "백엔드 빌드 상태: ${{ steps.build-status.outputs.status }}"
          color: ${{ steps.gradle-build.outcome == 'success' && '0x00ff00' || '0xff0000' }}
          status: ${{ steps.gradle-build.outcome }}

  build-frontend:
    name: 프론트엔드 빌드 테스트
    runs-on: ubuntu-latest

    steps:
      - name: 코드 체크아웃
        uses: actions/checkout@v3

      - name: Node.js 설정
        uses: actions/setup-node@v3
        with:
          node-version: "18"

      - name: 프론트엔드 파일 생성
        run: |
          echo "프론트엔드 디렉토리 확인:"
          ls -la ./be15_DevEagles_FE

          # assets 디렉토리 생성 및 필요한 파일 추가
          mkdir -p ./be15_DevEagles_FE/src/assets
          echo "/* 임시 스타일시트 */" > ./be15_DevEagles_FE/src/assets/main.css

          # 더미 SVG 로고 파일 생성
          echo '<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><circle cx="50" cy="50" r="40" stroke="black" stroke-width="3" fill="red" /></svg>' > ./be15_DevEagles_FE/src/assets/logo.svg

          # 컴포넌트 디렉토리 생성
          mkdir -p ./be15_DevEagles_FE/src/components

          # HelloWorld.vue 컴포넌트 생성 (base64로 인코딩된 문자열에서 디코딩)
          echo 'PHNjcmlwdCBzZXR1cD4KZGVmaW5lUHJvcHMoewogIG1zZzogewogICAgdHlwZTogU3RyaW5nLAogICAgcmVxdWlyZWQ6IHRydWUKICB9Cn0pCjwvc2NyaXB0PgoKPHRlbXBsYXRlPgogIDxkaXYgY2xhc3M9ImdyZWV0aW5ncyI+CiAgICA8aDEgY2xhc3M9ImdyZWVuIj57eyBtc2cgfX08L2gxPgogICAgPGgzPgogICAgICDruYTrk5wg7YWM7Iqk7Yq4IOuNnOuvuCDsu7Ttj6ztgqTtirjri5jri6QuCiAgICA8L2gzPgogIDwvZGl2Pgo8L3RlbXBsYXRlPgoKPHN0eWxlIHNjb3BlZD4KaDEgewogIGZvbnQtd2VpZ2h0OiA1MDA7CiAgZm9udC1zaXplOiAyLjZyZW07CiAgcG9zaXRpb246IHJlbGF0aXZlOwogIHRvcDogLTEwcHg7Cn0KCmgzIHsKICBmb250LXNpemU6IDEuMnJlbTsKfQoKLmdyZWV0aW5ncyBoMSwKLmdyZWV0aW5ncyBoMyB7CiAgdGV4dC1hbGlnbjogY2VudGVyOwp9CgpAbWVkaWEgKG1pbi13aWR0aDogMTAyNHB4KSB7CiAgLmdyZWV0aW5ncyBoMSwKICAuZ3JlZXRpbmdzIGgzIHsKICAgIHRleHQtYWxpZ246IGxlZnQ7CiAgfQp9Cjwvc3R5bGU+' | base64 -d > ./be15_DevEagles_FE/src/components/HelloWorld.vue

          # TheWelcome.vue 컴포넌트 생성 (base64로 인코딩된 문자열에서 디코딩)
          echo 'PHNjcmlwdCBzZXR1cD4KPC9zY3JpcHQ+Cgo8dGVtcGxhdGU+CiAgPGRpdiBjbGFzcz0id2VsY29tZSI+CiAgICA8aDE+67mE65OcIO2FjOyKpO2KuCDtjpjsnbTsp4A8L2gxPgogICAgPHA+7J20IO2OuOydtOyngOuKlCBDSS9DRCDZHOF7J2nsu6jrnbzsnbQg7YWM7Iqk7Yq4IO2WiO2VnCDrjZzrr7gg7Y6Y7J207KeA7J6F64uI64ukLjwvcD4KICA8L2Rpdj4KPC90ZW1wbGF0ZT4KCjxzdHlsZSBzY29wZWQ+Ci53ZWxjb21lIHsKICB0ZXh0LWFsaWduOiBjZW50ZXI7CiAgcGFkZGluZzogMjBweDsKfQo8L3N0eWxlPg==' | base64 -d > ./be15_DevEagles_FE/src/components/TheWelcome.vue

          # 생성된 파일 확인
          echo "컴포넌트 디렉토리 내용 확인:"
          ls -la ./be15_DevEagles_FE/src/components

      - name: NPM 캐시 설정
        uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('be15_DevEagles_FE/package.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: 의존성 설치
        working-directory: ./be15_DevEagles_FE
        run: npm install
        continue-on-error: true
        id: npm-install

      - name: 빌드 실행
        working-directory: ./be15_DevEagles_FE
        run: npm run build
        continue-on-error: true
        id: npm-build

      - name: 빌드 상태 확인
        id: fe-build-status
        run: |
          if ${{ steps.npm-build.outcome == 'success' }}; then
            echo "status=성공" >> $GITHUB_OUTPUT
          else
            echo "status=실패" >> $GITHUB_OUTPUT
          fi

      - name: Discord에 프론트엔드 빌드 결과 전송
        uses: sarisia/actions-status-discord@v1
        if: always()
        with:
          webhook: https://discordapp.com/api/webhooks/1373208730384076830/xJglBK0zwY531d7uyP6hh62DnjqwtowArFplYLKJ1ZfR6i35mQSv1NDf2kTaYo-zD03T
          title: "프론트엔드 빌드 테스트 결과"
          description: "프론트엔드 빌드 상태: ${{ steps.fe-build-status.outputs.status }}"
          color: ${{ steps.npm-build.outcome == 'success' && '0x00ff00' || '0xff0000' }}
          status: ${{ steps.npm-build.outcome }}
